<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule an Appointment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/request_appointment.css') }}">
</head>
<body class="my-6">

<header class="header">
    <div class="logo">
        <img src="{{ url_for('static', filename='images/OUR_SYSTEM_LOGO_SHAS.png') }}" alt="logo" class="img-fluid">
    </div>
    <div class="navs w-50">
        <ul class="nav">
            <li class="nav-item">
                <a class="nav-link active" href="/client/dashboard">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/client/profile">Profile</a>
            </li>
        </ul>
    </div>
</header>

<div class="container mt-5">
    <div class="row d-flex justify-content-center">
        <div class="col-md-8">
            <div class="card border-primary">
                <div class="card-header text-center bg-primary text-white">
                    <h2>Schedule an Appointment</h2>
                </div>
                <div class="card-body">
                    <!-- Form with id 'appointmentForm' -->
                    <form id="appointmentForm" class="row gy-2 gx-3 align-items-center">
                        <!-- Patient Details Section -->
                        <div class="mb-4">
                            <h4>Patient Details</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="fullName" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="fullName" name="full_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="dob" class="form-label">Date of Birth *</label>
                                    <input type="date" class="form-control" id="dob" name="date_of_birth" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="gender" class="form-label">Gender *</label>
                                    <select class="form-select" id="gender" name="gender" required>
                                        <option value="" selected disabled>Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="contactNumber" class="form-label">Contact Number *</label>
                                    <input type="text" class="form-control" id="contactNumber" name="contact_number" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="insurance" class="form-label">Insurance *</label>
                                    <input type="text" class="form-control" id="insurance" name="insurance" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="maritalStatus" class="form-label">Marital Status</label>
                                    <select class="form-select" id="maritalStatus" name="marital_status">
                                        <option value="" selected disabled>Select Marital Status</option>
                                        <option value="single">Single</option>
                                        <option value="married">Married</option>
                                        <option value="divorced">Divorced</option>
                                        <option value="widowed">Widowed</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="occupation" class="form-label">Occupation</label>
                                    <input type="text" class="form-control" id="occupation" name="occupation">
                                </div>
                                <div class="col-md-6">
                                    <label for="nextOfKin" class="form-label">Next of Kin</label>
                                    <input type="text" class="form-control" id="nextOfKin" name="next_of_kin">
                                </div>
                                <div class="col-md-6">
                                    <label for="addressCountry" class="form-label">Country</label>
                                    <input type="text" class="form-control" id="addressCountry" name="address_country">
                                </div>
                                <div class="col-md-6">
                                    <label for="addressDistrict" class="form-label">District</label>
                                    <input type="text" class="form-control" id="addressDistrict" name="address_district">
                                </div>
                                <div class="col-md-6">
                                    <label for="addressSector" class="form-label">Sector</label>
                                    <input type="text" class="form-control" id="addressSector" name="address_sector">
                                </div>
                                <div class="col-md-6">
                                    <label for="addressVillage" class="form-label">Village</label>
                                    <input type="text" class="form-control" id="addressVillage" name="address_village">
                                </div>
                                <div class="col-md-6">
                                    <label for="addressCell" class="form-label">Cell</label>
                                    <input type="text" class="form-control" id="addressCell" name="address_cell">
                                </div>
                            </div>
                        </div>

                        <!-- Appointment Schedule Section -->
                        <h4>Appointment Schedule</h4>
                        <!-- Service Selection -->
                        <div class="mb-3">
                            <label for="service" class="form-label">Select Service *</label>
                            <select class="form-select" id="service" name="service" required>
                                <option value="" selected disabled>Select Service</option>
                            </select>
                        </div>

                        <!-- Appointment Date and Time -->
                        <div class="mb-3">
                            <label for="appointmentDateTime" class="form-label">Select Date and Time *</label>
                            <input type="datetime-local" class="form-control" id="appointmentDateTime" name="appointment_date_time" required>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </form>
                    <!-- Placeholder for success/error message -->
                    <div id="responseMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- JavaScript to handle form submission and fetch services -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fetch services from the database
        async function fetchServices() {
            try {
                const response = await fetch('/client/services'); // Endpoint to get services
                const data = await response.json();

                if (response.ok) {
                    const services = data.services;
                    const serviceSelect = document.getElementById('service');

                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.service_id;
                        option.textContent = service.name;
                        serviceSelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to fetch services:', data.message);
                    showResponseMessage('Failed to load services. Please try again later.', 'danger');
                }
            } catch (error) {
                console.error('Error fetching services:', error);
                showResponseMessage('Error fetching services. Please check your connection.', 'danger');
            }
        }

        // Function to show response messages
        function showResponseMessage(message, type) {
            const responseMessage = document.getElementById('responseMessage');
            responseMessage.textContent = message;
            responseMessage.className = `alert alert-${type}`;
        }

        // Fetch services on page load
        fetchServices();

        // Handle form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission

            // Collect form data
            const formData = new FormData(this);

            // Prepare data for JSON submission
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            try {
                // Send a POST request to the server
                const response = await fetch('/client/submit_appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // Get the response
                const result = await response.json();
                if (response.ok) {
                    this.reset();
                    showResponseMessage('Appointment scheduled successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // Refresh the page after 2 seconds
                } else {
                    showResponseMessage(`Error: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showResponseMessage('An error occurred while scheduling the appointment. Please try again.', 'danger');
            }
        });
    });
</script>

</body>
</html>
